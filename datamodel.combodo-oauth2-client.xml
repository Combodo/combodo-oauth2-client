<?xml version="1.0" encoding="UTF-8"?>
<itop_design xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="3.2">
  <classes>
    <class id="Oauth2Client" _delta="define">
      <parent>cmdbAbstractObject</parent>
      <php_parent>
        <name>Combodo\iTop\Oauth2Client\Model\AbstractOauth2Client</name>
      </php_parent>
      <properties>
        <category>bizmodel,searchable</category>
        <abstract>true</abstract>
        <key_type>autoincrement</key_type>
        <db_table>priv_oauth2_client</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field>finalclass</db_final_class_field>
        <naming>
          <format>%1$s - %2$s</format>
          <attributes>
            <attribute id="name"/>
            <attribute id="provider"/>
          </attributes>
        </naming>
        <display_template/>
        <icon>assets/img/itop-logo-square-64.png</icon>
        <reconciliation>
          <attributes>
            <attribute id="name"/>
            <attribute id="provider"/>
          </attributes>
        </reconciliation>
        <uniqueness_rules>
          <rule id="no_duplicate">
            <attributes>
              <attribute id="name"/>
              <attribute id="provider"/>
            </attributes>
          </rule>
        </uniqueness_rules>
      </properties>
      <fields>
        <field id="name" xsi:type="AttributeString">
          <sql>name</sql>
          <default_value/>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <field id="provider" xsi:type="AttributeString">
          <sql>provider</sql>
          <default_value/>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <field id="client_id" xsi:type="AttributeString">
          <sql>client_id</sql>
          <default_value/>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <field id="client_secret" xsi:type="AttributeEncryptedPassword">
          <sql>client_secret</sql>
          <default_value/>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <field id="refresh_token" xsi:type="AttributeEncryptedPassword">
          <sql>refresh_token</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
          <tracking_level>none</tracking_level>
        </field>
        <field id="refresh_token_expiration" xsi:type="AttributeDateTime">
          <sql>refresh_token_expiration</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
          <tracking_level>none</tracking_level>
        </field>
        <field id="access_token" xsi:type="AttributeEncryptedPassword">
          <sql>access_token</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
          <tracking_level>none</tracking_level>
        </field>
        <field id="access_token_expiration" xsi:type="AttributeDateTime">
          <sql>access_token_expiration</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
          <tracking_level>none</tracking_level>
        </field>
        <field id="scope" xsi:type="AttributeString">
          <sql>scope</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
        </field>
        <field id="status" xsi:type="AttributeEnum">
          <values>
            <value id="active">
              <code>active</code>
              <style>
                <main_color>$ibo-lifecycle-active-state-primary-color</main_color>
                <complementary_color>$ibo-lifecycle-active-state-secondary-color</complementary_color>
                <decoration_classes/>
              </style>
            </value>
            <value id="inactive">
              <code>inactive</code>
              <style>
                <main_color>$ibo-lifecycle-inactive-state-primary-color</main_color>
                <complementary_color>$ibo-lifecycle-inactive-state-secondary-color</complementary_color>
                <decoration_classes/>
              </style>
            </value>
          </values>
          <sql>status</sql>
          <default_value>active</default_value>
          <is_null_allowed>true</is_null_allowed>
          <display_style>list</display_style>
        </field>
        <field id="token_type" xsi:type="AttributeString">
          <sql>token_type</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
          <tracking_level>none</tracking_level>
        </field>
      </fields>
      <event_listeners>
        <event_listener id="EVENT_DB_BEFORE_WRITE">
          <event>EVENT_DB_BEFORE_WRITE</event>
          <callback>EvtBeforeWriteOauthClient2</callback>
          <rank>0</rank>
        </event_listener>
        <event_listener id="EVENT_DB_SET_ATTRIBUTES_FLAGS">
          <event>EVENT_DB_SET_ATTRIBUTES_FLAGS</event>
          <callback>EvtSetAttributeFlagsOauthClient2</callback>
          <rank>0</rank>
        </event_listener>
        <event_listener id="EVENT_DB_SET_INITIAL_ATTRIBUTES_FLAGS">
          <event>EVENT_DB_SET_INITIAL_ATTRIBUTES_FLAGS</event>
          <callback>EvtSetInitialAttributeFlagsOauthClient2</callback>
          <rank>0</rank>
        </event_listener>
      </event_listeners>
      <methods>
				<method id="GetToken">
          <static>false</static>
          <access>public</access>
          <type>Overload-DBObject</type>
          <code><![CDATA[
        public function GetToken(Oauth2Client $oOauth2Client) : string
        {
          return Combodo\iTop\Oauth2Client\Service\Oauth2ClientService::GetInstance()->GetToken($this);
        }
]]></code>
        </method>
        <method id="GetHybridauthProvider">
          <static>false</static>
          <access>public</access>
          <type>Overload-DBObject</type>
          <code><![CDATA[
        public function GetHybridauthProvider() : string
        {
          return Combodo\iTop\Oauth2Client\Model\ConfigService::GetInstance()->GetHybridauthProvider($this);
        }
]]></code>
        </method>
        <method id="PrefillCreationForm">
          <static>false</static>
          <access>public</access>
          <type>Overload-DBObject</type>
          <code><![CDATA[
	public function PrefillCreationForm(&$aContextParam)
	{
		$this->Set('provider', $this->GetHybridauthProvider());

		parent::PrefillCreationForm($aContextParam);
	}
]]></code>
        </method>
        <method id="EvtBeforeWriteOauthClient2">
          <comment>/**
            * Event Listener for EVENT_DB_BEFORE_WRITE
            * An object is about to be written into the database.
            * The object can be modified.
            *
            * @param Combodo\iTop\Service\Events\EventData $oEventData Event data object
            */
          </comment>
          <static>false</static>
          <access>public</access>
          <type>EventListener</type>
          <code><![CDATA[	public function EvtBeforeWriteOauthClient2(Combodo\iTop\Service\Events\EventData $oEventData)
          {
            if ($oEventData->Get('is_new')) {
							$this->Set('provider', $this->GetHybridauthProvider());
            }
          }]]></code>
        </method>
        <method id="EvtSetAttributeFlagsOauthClient2">
          <comment>/**
            *
            * @param Combodo\iTop\Service\Events\EventData $oEventData Event data object
            */
          </comment>
          <static>false</static>
          <access>public</access>
          <type>EventListener</type>
          <code><![CDATA[
	        public function EvtSetAttributeFlagsOauthClient2(Combodo\iTop\Service\Events\EventData $oEventData)
          {
                $this->AddAttributeFlags('access_token', OPT_ATT_READONLY);
                $this->AddAttributeFlags('access_token_expiration', OPT_ATT_READONLY);
                $this->AddAttributeFlags('refresh_token', OPT_ATT_READONLY);
                $this->AddAttributeFlags('refresh_token_expiration', OPT_ATT_READONLY);
          }]]></code>
        </method>
        <method id="EvtSetInitialAttributeFlagsOauthClient2">
          <comment>/**
            *
            * @param Combodo\iTop\Service\Events\EventData $oEventData Event data object
            */
          </comment>
          <static>false</static>
          <access>public</access>
          <type>EventListener</type>
          <code><![CDATA[
	        public function EvtSetInitialAttributeFlagsOauthClient2(Combodo\iTop\Service\Events\EventData $oEventData)
          {
                $this->AddInitialAttributeFlags('access_token', OPT_ATT_READONLY);
                $this->AddInitialAttributeFlags('access_token_expiration', OPT_ATT_READONLY);
                $this->AddInitialAttributeFlags('refresh_token', OPT_ATT_READONLY);
                $this->AddInitialAttributeFlags('refresh_token_expiration', OPT_ATT_READONLY);
          }]]></code>
        </method>
        <method id="GetAccessTokenModelToHybridauthMapping">
          <static>false</static>
          <access>public</access>
          <type>Overload-DBObject</type>
          <code><![CDATA[

        /**
        * Provide the acces_token fields mapping between hybridauth and iTop model
        * @return array
        */
        public function GetAccessTokenModelToHybridauthMapping() : array {
          return Combodo\iTop\Oauth2Client\Model\ConfigService::GetInstance()->GetAccessTokenModelToHybridauthMapping();
        }
        ]]></code>
        </method>
        <method id="GetModelToHybridauthMapping">
          <static>false</static>
          <access>public</access>
          <type>Overload-DBObject</type>
          <code><![CDATA[

        /**
        * Provide the mapping between hybridauth and iTop model
        * @return array
        */
        public function GetModelToHybridauthMapping() : array {
          return Combodo\iTop\Oauth2Client\Model\ConfigService::GetInstance()->GetModelToHybridauthMapping();
        }
        ]]></code>
        </method>
        <method id="DisplayBareHeader">
          <static>false</static>
          <access>public</access>
          <type>Overload-DBObject</type>
          <code><![CDATA[
  public function DisplayBareHeader(WebPage $oPage, $bEditMode = false)
  {
		$aHeaderBlocks = parent::DisplayBareHeader($oPage, $bEditMode);

    $aOauthConnectButtons = Combodo\iTop\Oauth2Client\Controller\Oauth2ClientController::GetButtons($this, $oPage);

		// Add the buttons in the existing toolbar
		reset($aHeaderBlocks['toolbar']);
		$sToolbarContainerKey = key($aHeaderBlocks['toolbar']);
		foreach ($aHeaderBlocks['toolbar'][$sToolbarContainerKey]->GetSubBlocks() as $sSubBlockId => $oSubBlock) {
			if (!($oSubBlock instanceof Combodo\iTop\Application\UI\Base\Component\Toolbar\Toolbar)) {
				continue;
			}
			// Look for the actions menu toolbar by checking if its ID starts with the good prefix
			if (stripos($sSubBlockId, MenuBlock::ACTIONS_TOOLBAR_ID_PREFIX) === 0) {
			  foreach($aOauthConnectButtons as $oOauthConnectButton)
			  {
				$oSubBlock->PrependSubBlock($oOauthConnectButton);
			  }
				break;
			}
		}

		return $aHeaderBlocks;

   }
        ]]></code>
        </method>
      </methods>
      <presentation>
        <details>
          <items>
            <item id="col:col1">
              <rank>10</rank>
              <items>
                <item id="name">
                  <rank>10</rank>
                </item>
                <item id="provider">
                  <rank>20</rank>
                </item>
                <item id="status">
                  <rank>30</rank>
                </item>
                <item id="client_id">
                  <rank>40</rank>
                </item>
                <item id="client_secret">
                  <rank>50</rank>
                </item>
                <item id="scope">
                  <rank>60</rank>
                </item>
              </items>
            </item>
            <item id="col:col2">
              <rank>10</rank>
              <items>
                <item id="access_token">
                  <rank>70</rank>
                </item>
                <item id="access_token_expiration">
                  <rank>80</rank>
                </item>
                <item id="refresh_token">
                  <rank>90</rank>
                </item>
                <item id="refresh_token_expiration">
                  <rank>100</rank>
                </item>
                <item id="token_type">
                  <rank>110</rank>
                </item>
              </items>
            </item>
          </items>
        </details>
        <search>
          <items>
            <item id="name">
              <rank>10</rank>
            </item>
            <item id="provider">
              <rank>20</rank>
            </item>
          </items>
        </search>
        <list>
          <items>
            <item id="name">
              <rank>10</rank>
            </item>
            <item id="provider">
              <rank>20</rank>
            </item>
          </items>
        </list>
      </presentation>
    </class>
    <class id="GitHubOauth2Client" _delta="define">
      <parent>Oauth2Client</parent>
      <properties>
        <category>bizmodel,searchable</category>
        <abstract>false</abstract>
        <key_type>autoincrement</key_type>
        <db_table>priv_oauth2_client_github</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field>finalclass</db_final_class_field>
        <naming>
          <format>%1$s - %2$s</format>
          <attributes>
            <attribute id="name"/>
            <attribute id="provider"/>
          </attributes>
        </naming>
        <display_template/>
        <icon>assets/img/itop-logo-square-64.png</icon>
        <reconciliation>
          <attributes>
            <attribute id="name"/>
            <attribute id="provider"/>
          </attributes>
        </reconciliation>
      </properties>
      <fields/>
      <methods/>
      <presentation/>
    </class>
    <class id="MicrosoftGraphOauth2Client" _delta="define">
      <parent>Oauth2Client</parent>
      <properties>
        <category>bizmodel,searchable</category>
        <abstract>false</abstract>
        <key_type>autoincrement</key_type>
        <db_table>priv_oauth2_client_microsoftgraph</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field>finalclass</db_final_class_field>
        <naming>
          <format>%1$s - %2$s</format>
          <attributes>
            <attribute id="name"/>
            <attribute id="tenant"/>
            <attribute id="provider"/>
          </attributes>
        </naming>
        <display_template/>
        <icon>assets/img/itop-logo-square-64.png</icon>
        <reconciliation>
          <attributes>
            <attribute id="name"/>
            <attribute id="tenant"/>
            <attribute id="provider"/>
          </attributes>
        </reconciliation>
      </properties>
      <fields>
        <field id="tenant" xsi:type="AttributeString">
          <sql>tenant</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
        </field>
      </fields>
      <methods/>
      <presentation>
        <details>
          <items>
            <item id="col:col1">
              <rank>10</rank>
              <items>
                <item id="name">
                  <rank>10</rank>
                </item>
                <item id="tenant">
                  <rank>15</rank>
                </item>
                <item id="provider">
                  <rank>20</rank>
                </item>
                <item id="status">
                  <rank>30</rank>
                </item>
                <item id="client_id">
                  <rank>40</rank>
                </item>
                <item id="client_secret">
                  <rank>50</rank>
                </item>
                <item id="scope">
                  <rank>60</rank>
                </item>
              </items>
            </item>
            <item id="col:col2">
              <rank>10</rank>
              <items>
                <item id="access_token">
                  <rank>70</rank>
                </item>
                <item id="access_token_expiration">
                  <rank>80</rank>
                </item>
                <item id="refresh_token">
                  <rank>90</rank>
                </item>
                <item id="refresh_token_expiration">
                  <rank>100</rank>
                </item>
                <item id="token_type">
                  <rank>110</rank>
                </item>
              </items>
            </item>
          </items>
        </details>
        <search>
          <items>
            <item id="name">
              <rank>10</rank>
            </item>
            <item id="tenant">
              <rank>15</rank>
            </item>
            <item id="provider">
              <rank>20</rank>
            </item>
          </items>
        </search>
        <list>
          <items>
            <item id="name">
              <rank>10</rank>
            </item>
            <item id="tenant">
              <rank>15</rank>
            </item>
            <item id="provider">
              <rank>20</rank>
            </item>
          </items>
        </list>
      </presentation>
    </class>
    <class id="GoogleOauth2Client" _delta="define">
      <parent>Oauth2Client</parent>
      <properties>
        <category>bizmodel,searchable</category>
        <abstract>false</abstract>
        <key_type>autoincrement</key_type>
        <db_table>priv_oauth2_client_google</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field>finalclass</db_final_class_field>
        <naming>
          <format>%1$s - %2$s</format>
          <attributes>
            <attribute id="name"/>
            <attribute id="provider"/>
          </attributes>
        </naming>
        <display_template/>
        <icon>assets/img/itop-logo-square-64.png</icon>
        <reconciliation>
          <attributes>
            <attribute id="name"/>
            <attribute id="provider"/>
          </attributes>
        </reconciliation>
      </properties>
      <fields/>
      <methods/>
      <presentation/>
    </class>
  </classes>
</itop_design>
